---
#############################################
# TemplateBot workflow to find repositories #
# and insert templates                      #
#############################################
name: TemplateBot

#################################################
# Set to run on schedule or on just random runs #
#################################################
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
  # Un-comment to run on schedule default every 2 hrs
  # schedule:
  #   - cron: '0 */2 * * *'

###########################
# Set Permission to write #
###########################
permissions:
  contents: write

###############
# Set the Job #
###############
jobs:
  TemplateBot:
    runs-on: ubuntu-latest
    steps:
      ####################################################################
      # generate a token that gives us access to all repositories in org #
      ####################################################################
      - name: Generate Token
        uses: navikt/github-app-token-generator@v1
        id: get-token
        with:
          private-key: ${{ secrets.PRIVATE_KEY }}
          app-id: ${{ secrets.APP_ID }}

      ######################
      # Install needed lib #
      ######################
      - name: Install TweetSodium for encryption
        run: npm install tweetsodium

      ############################
      # Create the GitHub secret #
      ############################
      - name: Create the GitHub Secret
        uses: actions/github-script@v5
        with:
          script: |
            const sodium = require('tweetsodium')
            const key = await github.rest.actions.getRepoPublicKey({
              owner: context.repo.owner,
              repo: context.repo.repo,
            })
            const value = "${{ steps.get-token.outputs.token }}"

            // Convert the message and key to Uint8Array's (Buffer implements that interface)
            const messageBytes = Buffer.from(value)
            const keyBytes = Buffer.from(key, 'base64')
            // Encrypt using LibSodium.
            const encryptedBytes = sodium.seal(messageBytes, keyBytes)
            // Base64 the encrypted secret
            const encrypted = Buffer.from(encryptedBytes).toString('base64')
            console.log(encrypted)

            github.rest.actions.createOrUpdateSecret({
              owner: context.repo.owner,
              repo: context.repo.repo,
              secret_name: 'TEMPLATE_BOT_TOKEN',
              encrypted_value: encrypted
            })

      ##################################################
      # Checks-out TemplateBot under $GITHUB_WORKSPACE #
      ##################################################
      - name: Checkout TemplateBot
        uses: actions/checkout@v2

      #######################
      # Run the TemplateBot #
      #######################
      - name: Find and Add Templates
        env:
          DEBUG: true
          GITHUB_TOKEN: ${{ secrets.TEMPLATE_BOT_TOKEN }}
          #GITHUB_TOKEN: ${{ steps.get-token.outputs.token }}
          ORG_NAME: "lukastestorganization"
        run: ./.automation/template-the-world.sh
